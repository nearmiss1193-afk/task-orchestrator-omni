<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Service Co ‚Äî Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-card: rgba(18, 18, 28, 0.8);
            --bg-card-hover: rgba(25, 25, 40, 0.9);
            --border: rgba(255, 255, 255, 0.06);
            --border-active: rgba(99, 102, 241, 0.4);
            --text-primary: #f0f0f5;
            --text-secondary: #8b8b9e;
            --text-muted: #55556a;
            --accent-blue: #6366f1;
            --accent-green: #10b981;
            --accent-amber: #f59e0b;
            --accent-rose: #f43f5e;
            --accent-purple: #a855f7;
            --accent-cyan: #06b6d4;
            --glow-blue: rgba(99, 102, 241, 0.15);
            --glow-green: rgba(16, 185, 129, 0.15);
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Ambient background */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(ellipse at 20% 50%, rgba(99, 102, 241, 0.04) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(168, 85, 247, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(6, 182, 212, 0.03) 0%, transparent 50%);
            z-index: 0;
            pointer-events: none;
        }

        .app {
            position: relative;
            z-index: 1;
        }

        /* Top Bar */
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 32px;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(10, 10, 15, 0.85);
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .topbar-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 16px;
        }

        .topbar-title {
            font-weight: 700;
            font-size: 18px;
            letter-spacing: -0.3px;
        }

        .topbar-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-green);
        }

        .status-pill .dot {
            width: 7px;
            height: 7px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }

        .status-pill.degraded {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.2);
            color: var(--accent-amber);
        }

        .status-pill.degraded .dot {
            background: var(--accent-amber);
        }

        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .time-display {
            font-size: 12px;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
        }

        /* Main Layout */
        .main {
            padding: 24px 32px;
            max-width: 1440px;
            margin: 0 auto;
        }

        /* Metric Cards Row */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .metric-card:hover {
            border-color: var(--border-active);
        }

        .metric-card:hover::before {
            opacity: 1;
        }

        .metric-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1px;
            line-height: 1;
        }

        .metric-sub {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .metric-icon {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 20px;
            opacity: 0.5;
        }

        /* Live Feed + Panels */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .panel-title {
            font-size: 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-blue);
        }

        .panel-body {
            padding: 16px 20px;
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }

        /* Feed Items */
        .feed-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .feed-item:last-child {
            border-bottom: none;
        }

        .feed-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .feed-icon.call {
            background: rgba(99, 102, 241, 0.15);
        }

        .feed-icon.sms {
            background: rgba(16, 185, 129, 0.15);
        }

        .feed-icon.email {
            background: rgba(245, 158, 11, 0.15);
        }

        .feed-icon.alert {
            background: rgba(244, 63, 94, 0.15);
        }

        .feed-icon.system {
            background: rgba(168, 85, 247, 0.15);
        }

        .feed-content {
            flex: 1;
            min-width: 0;
        }

        .feed-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .feed-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .feed-time {
            font-size: 10px;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
            flex-shrink: 0;
            margin-top: 2px;
        }

        /* Status Grid */
        .integration-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .integration-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .integration-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .integration-dot.green {
            background: var(--accent-green);
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
        }

        .integration-dot.amber {
            background: var(--accent-amber);
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
        }

        .integration-dot.red {
            background: var(--accent-rose);
            box-shadow: 0 0 8px rgba(244, 63, 94, 0.4);
        }

        .integration-name {
            font-size: 13px;
            font-weight: 600;
        }

        .integration-status {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Quick Action Buttons */
        .action-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .action-btn:hover {
            background: rgba(99, 102, 241, 0.08);
            border-color: var(--border-active);
            transform: translateY(-1px);
        }

        .action-btn .icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .action-btn .label-sub {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* Leads Table */
        .leads-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leads-table thead th {
            text-align: left;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
        }

        .leads-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .leads-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .leads-table td {
            padding: 12px 16px;
            font-size: 13px;
        }

        .leads-table .lead-name {
            font-weight: 600;
        }

        .leads-table .lead-contact {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tag-blue {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }

        .tag-green {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }

        .tag-amber {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }

        .tag-rose {
            background: rgba(244, 63, 94, 0.15);
            color: #fb7185;
        }

        .tag-purple {
            background: rgba(168, 85, 247, 0.15);
            color: #c084fc;
        }

        /* Auth Gate */
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(30px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            max-width: 380px;
            width: 100%;
            text-align: center;
        }

        .auth-box h2 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .auth-box p {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .auth-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            color: var(--text-primary);
            font-size: 16px;
            text-align: center;
            letter-spacing: 4px;
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: border-color 0.2s;
            margin-bottom: 16px;
        }

        .auth-input:focus {
            border-color: var(--accent-blue);
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .auth-btn:hover {
            opacity: 0.9;
        }

        .auth-error {
            color: var(--accent-rose);
            font-size: 12px;
            margin-top: 12px;
            display: none;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .metrics-row {
                grid-template-columns: repeat(3, 1fr);
            }

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }

            .topbar {
                padding: 12px 16px;
            }

            .main {
                padding: 16px;
            }
        }

        @media (max-width: 640px) {
            .metrics-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .integration-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        /* Shimmer loading */
        .shimmer {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.03) 25%, rgba(255, 255, 255, 0.06) 50%, rgba(255, 255, 255, 0.03) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .refresh-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            color: var(--accent-blue);
            background: rgba(99, 102, 241, 0.1);
        }
    </style>
</head>

<body>
    <!-- AUTH GATE -->
    <div id="authGate" class="auth-overlay">
        <div class="auth-box">
            <div style="font-size: 32px; margin-bottom: 16px;">‚ö°</div>
            <h2>Command Center</h2>
            <p>Enter access code to continue</p>
            <input type="password" id="authInput" class="auth-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autofocus>
            <button onclick="authenticate()" class="auth-btn">Authenticate</button>
            <div id="authError" class="auth-error">Access denied</div>
        </div>
    </div>

    <div class="app">
        <!-- TOP BAR -->
        <header class="topbar">
            <div class="topbar-left">
                <div class="topbar-logo">A</div>
                <div>
                    <div class="topbar-title">AI Service Co</div>
                    <div class="topbar-subtitle">Command Center</div>
                </div>
            </div>
            <div class="topbar-right">
                <div class="time-display" id="clockDisplay">--:--:-- PM</div>
                <div class="status-pill" id="systemStatus">
                    <div class="dot"></div>
                    <span id="systemStatusText">Connecting...</span>
                </div>
                <button class="refresh-btn" onclick="refreshAll()" title="Refresh all data">‚Üª Refresh</button>
            </div>
        </header>

        <main class="main">
            <!-- METRIC CARDS -->
            <div class="metrics-row">
                <div class="metric-card">
                    <div class="metric-icon">üë•</div>
                    <div class="metric-label">Total Leads</div>
                    <div class="metric-value" id="metricLeads">‚Äî</div>
                    <div class="metric-sub" id="metricLeadsSub">Loading...</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üì§</div>
                    <div class="metric-label">Outreach (24h)</div>
                    <div class="metric-value" id="metricOutreach">‚Äî</div>
                    <div class="metric-sub" id="metricOutreachSub">Loading...</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üìû</div>
                    <div class="metric-label">AI Calls</div>
                    <div class="metric-value" id="metricCalls">‚Äî</div>
                    <div class="metric-sub" id="metricCallsSub">Loading...</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üí∞</div>
                    <div class="metric-label">Pipeline Value</div>
                    <div class="metric-value" id="metricPipeline">‚Äî</div>
                    <div class="metric-sub" id="metricPipelineSub">$49-99/mo per client</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üîî</div>
                    <div class="metric-label">Alerts Today</div>
                    <div class="metric-value" id="metricAlerts">‚Äî</div>
                    <div class="metric-sub" id="metricAlertsSub">Loading...</div>
                </div>
            </div>

            <!-- LIVE FEED + RECENT CALLS -->
            <div class="grid-2">
                <!-- Live Activity Feed -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span>üì°</span> Live Activity
                            <span class="panel-badge" id="feedCount">0</span>
                        </div>
                        <button class="refresh-btn" onclick="fetchActivity()">‚Üª</button>
                    </div>
                    <div class="panel-body" id="activityFeed">
                        <div class="feed-item">
                            <div class="feed-content">
                                <div class="feed-desc" style="color: var(--text-muted)">Loading activity feed...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Calls -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span>üìû</span> Recent Calls
                            <span class="panel-badge" id="callCount">0</span>
                        </div>
                        <button class="refresh-btn" onclick="fetchCalls()">‚Üª</button>
                    </div>
                    <div class="panel-body" id="callsFeed">
                        <div class="feed-item">
                            <div class="feed-content">
                                <div class="feed-desc" style="color: var(--text-muted)">Loading calls...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INTEGRATIONS + QUICK ACTIONS + NOTIFICATIONS -->
            <div class="grid-3">
                <!-- Integration Status -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span>üîó</span> Integrations</div>
                    </div>
                    <div class="panel-body">
                        <div class="integration-grid" id="integrationGrid">
                            <div class="integration-item">
                                <div class="integration-dot green" id="intModal"></div>
                                <div>
                                    <div class="integration-name">Modal</div>
                                    <div class="integration-status" id="intModalStatus">Checking...</div>
                                </div>
                            </div>
                            <div class="integration-item">
                                <div class="integration-dot green" id="intVapi"></div>
                                <div>
                                    <div class="integration-name">Vapi</div>
                                    <div class="integration-status">Sarah Online</div>
                                </div>
                            </div>
                            <div class="integration-item">
                                <div class="integration-dot green" id="intGHL"></div>
                                <div>
                                    <div class="integration-name">GHL</div>
                                    <div class="integration-status" id="intGHLStatus">Connected</div>
                                </div>
                            </div>
                            <div class="integration-item">
                                <div class="integration-dot green" id="intResend"></div>
                                <div>
                                    <div class="integration-name">Resend</div>
                                    <div class="integration-status">Email Ready</div>
                                </div>
                            </div>
                            <div class="integration-item">
                                <div class="integration-dot green" id="intSupabase"></div>
                                <div>
                                    <div class="integration-name">Supabase</div>
                                    <div class="integration-status" id="intSupabaseStatus">Connected</div>
                                </div>
                            </div>
                            <div class="integration-item">
                                <div class="integration-dot green" id="intHeartbeat"></div>
                                <div>
                                    <div class="integration-name">Heartbeat</div>
                                    <div class="integration-status" id="intHeartbeatStatus">Checking...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span>‚ö°</span> Quick Actions</div>
                    </div>
                    <div class="panel-body" style="display: flex; flex-direction: column; gap: 8px;">
                        <button class="action-btn" onclick="triggerAction('call_sarah')">
                            <div class="icon" style="background: rgba(99,102,241,0.15);">üìû</div>
                            <div>
                                <div>Call Sarah</div>
                                <div class="label-sub">Test voice AI inbound</div>
                            </div>
                        </button>
                        <button class="action-btn" onclick="triggerAction('system_health')">
                            <div class="icon" style="background: rgba(16,185,129,0.15);">üè•</div>
                            <div>
                                <div>System Health Check</div>
                                <div class="label-sub">Full diagnostics report</div>
                            </div>
                        </button>
                        <button class="action-btn" onclick="triggerAction('view_logs')">
                            <div class="icon" style="background: rgba(245,158,11,0.15);">üìã</div>
                            <div>
                                <div>View Modal Logs</div>
                                <div class="label-sub">Recent function executions</div>
                            </div>
                        </button>
                        <button class="action-btn" onclick="window.open('https://app.gohighlevel.com','_blank')">
                            <div class="icon" style="background: rgba(244,63,94,0.15);">üîó</div>
                            <div>
                                <div>Open GHL</div>
                                <div class="label-sub">CRM & workflows</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Notification Log -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span>üîî</span> Notification Log</div>
                        <button class="refresh-btn" onclick="fetchNotifications()">‚Üª</button>
                    </div>
                    <div class="panel-body" id="notifFeed">
                        <div class="feed-item">
                            <div class="feed-content">
                                <div class="feed-desc" style="color: var(--text-muted)">Loading notifications...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RECENT LEADS TABLE -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><span>üë•</span> Lead Pipeline</div>
                    <button class="refresh-btn" onclick="fetchLeads()">‚Üª</button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="leads-table">
                        <thead>
                            <tr>
                                <th>Name / Business</th>
                                <th>Contact</th>
                                <th>Status</th>
                                <th>Source</th>
                                <th>Last Touch</th>
                                <th>Added</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 32px;">
                                    Loading leads...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ========== CONFIG ==========
        const MODAL_URL = 'https://nearmiss1193-afk--ghl-omni-automation';
        const STATS_URL = `${MODAL_URL}-sovereign-stats.modal.run`;
        const VAPI_WEBHOOK_URL = `${MODAL_URL}-vapi-webhook.modal.run`;
        const SUPABASE_URL = 'https://rzcpfwkygdvoshtwxncs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ6Y3Bmd2t5Z2R2b3NodHd4bmNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1OTA0MjQsImV4cCI6MjA4MjE2NjQyNH0.tWtGxrb4mZxjJggwKTkLpLk2GBi4d_zyUUq1nJMFnkk';
        const SESSION_CODE = 'SOVEREIGN';
        const GATE_KEY = 'EMPIRE_ACCESS_V2';

        // ========== AUTH ==========
        function checkSession() {
            if (localStorage.getItem(GATE_KEY) === 'AUTHORIZED') {
                document.getElementById('authGate').style.display = 'none';
                init();
            }
        }
        function authenticate() {
            const input = document.getElementById('authInput');
            if (input.value === SESSION_CODE) {
                localStorage.setItem(GATE_KEY, 'AUTHORIZED');
                document.getElementById('authGate').style.display = 'none';
                init();
            } else {
                document.getElementById('authError').style.display = 'block';
                input.value = '';
                input.style.borderColor = 'var(--accent-rose)';
                setTimeout(() => { input.style.borderColor = ''; }, 2000);
            }
        }
        document.getElementById('authInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') authenticate();
        });

        // ========== CLOCK ==========
        function updateClock() {
            const now = new Date();
            document.getElementById('clockDisplay').textContent = now.toLocaleString('en-US', {
                hour: 'numeric', minute: '2-digit', second: '2-digit',
                hour12: true, timeZone: 'America/New_York'
            }) + ' ET';
        }

        // ========== SUPABASE HELPER ==========
        async function supabaseQuery(table, select = '*', params = {}) {
            let url = `${SUPABASE_URL}/rest/v1/${table}?select=${encodeURIComponent(select)}`;
            for (const [k, v] of Object.entries(params)) {
                url += `&${k}=${encodeURIComponent(v)}`;
            }
            const res = await fetch(url, {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Prefer': params._count ? 'count=exact' : ''
                }
            });
            if (params._count) {
                const count = res.headers.get('content-range');
                return count ? parseInt(count.split('/')[1]) : 0;
            }
            return await res.json();
        }

        // ========== FETCH STATS (Modal) ==========
        async function fetchStats() {
            try {
                const res = await fetch(STATS_URL, { signal: AbortSignal.timeout(8000) });
                const data = await res.json();

                document.getElementById('metricLeads').textContent = (data.total_leads || 0).toLocaleString();
                document.getElementById('metricLeadsSub').textContent = 'Contactable pool';
                document.getElementById('metricOutreach').textContent = (data.outbound_24h || 0).toLocaleString();
                document.getElementById('metricOutreachSub').textContent = 'Emails, SMS, calls';

                const pipeline = (data.total_leads || 0) * 49;
                document.getElementById('metricPipeline').textContent = '$' + pipeline.toLocaleString();

                // Health
                const health = data.health || {};
                const isHealthy = health.status === 'healthy';
                const statusEl = document.getElementById('systemStatus');
                const statusText = document.getElementById('systemStatusText');
                statusText.textContent = isHealthy ? 'All Systems Online' : 'Degraded';
                statusEl.className = isHealthy ? 'status-pill' : 'status-pill degraded';

                // Heartbeat
                const hbDot = document.getElementById('intHeartbeat');
                const hbStatus = document.getElementById('intHeartbeatStatus');
                hbDot.className = `integration-dot ${isHealthy ? 'green' : 'amber'}`;
                if (health.last_heartbeat) {
                    const ago = Math.round((Date.now() - new Date(health.last_heartbeat).getTime()) / 60000);
                    hbStatus.textContent = `${ago}m ago`;
                } else {
                    hbStatus.textContent = 'No data';
                }

                // Modal status
                document.getElementById('intModalStatus').textContent = 'Deployed';

            } catch (e) {
                console.warn('Stats fetch failed:', e);
                document.getElementById('systemStatusText').textContent = 'API Offline';
                document.getElementById('systemStatus').className = 'status-pill degraded';
                document.getElementById('intModalStatus').textContent = 'Offline';
                document.getElementById('intModal').className = 'integration-dot red';
            }
        }

        // ========== FETCH CALLS (Vapi via Supabase) ==========
        async function fetchCalls() {
            try {
                const calls = await supabaseQuery('customer_memory', 'phone_number,context_summary,updated_at', {
                    'order': 'updated_at.desc',
                    'limit': 10
                });

                const container = document.getElementById('callsFeed');
                document.getElementById('callCount').textContent = calls.length;

                if (!calls.length) {
                    container.innerHTML = '<div class="feed-item"><div class="feed-content"><div class="feed-desc" style="color: var(--text-muted)">No recent calls</div></div></div>';
                    return;
                }

                container.innerHTML = calls.map(c => {
                    const ctx = typeof c.context_summary === 'string' ? { history: c.context_summary } : (c.context_summary || {});
                    const name = ctx.contact_name || 'Unknown';
                    const history = (ctx.history || '').split('\n').filter(Boolean);
                    const lastEntry = history[history.length - 1] || 'No details';
                    const ago = timeAgo(c.updated_at);

                    return `<div class="feed-item">
                        <div class="feed-icon call">üìû</div>
                        <div class="feed-content">
                            <div class="feed-title">${escHtml(name)} ‚Äî ${escHtml(c.phone_number)}</div>
                            <div class="feed-desc">${escHtml(lastEntry.substring(0, 120))}</div>
                        </div>
                        <div class="feed-time">${ago}</div>
                    </div>`;
                }).join('');

                document.getElementById('metricCalls').textContent = calls.length;
                document.getElementById('metricCallsSub').textContent = 'In memory bank';

            } catch (e) {
                console.warn('Calls fetch failed:', e);
            }
        }

        // ========== FETCH ACTIVITY ==========
        async function fetchActivity() {
            try {
                const touches = await supabaseQuery('outbound_touches', 'company,channel,status,ts', {
                    'order': 'ts.desc',
                    'limit': 15
                });

                const container = document.getElementById('activityFeed');
                document.getElementById('feedCount').textContent = touches.length;

                if (!touches.length) {
                    container.innerHTML = '<div class="feed-item"><div class="feed-content"><div class="feed-desc" style="color: var(--text-muted)">No recent activity</div></div></div>';
                    return;
                }

                container.innerHTML = touches.map(t => {
                    const icons = { email: 'üìß', sms: 'üí¨', call: 'üìû', social: 'üåê', voice_drop: 'üîä' };
                    const classes = { email: 'email', sms: 'sms', call: 'call', social: 'system', voice_drop: 'alert' };
                    const icon = icons[t.channel] || 'üì§';
                    const cls = classes[t.channel] || 'system';

                    return `<div class="feed-item">
                        <div class="feed-icon ${cls}">${icon}</div>
                        <div class="feed-content">
                            <div class="feed-title">${escHtml(t.company || 'Unknown')}</div>
                            <div class="feed-desc">${escHtml(t.channel || '')} ‚Äî ${escHtml(t.status || '')}</div>
                        </div>
                        <div class="feed-time">${timeAgo(t.ts)}</div>
                    </div>`;
                }).join('');

            } catch (e) {
                console.warn('Activity fetch failed:', e);
            }
        }

        // ========== FETCH NOTIFICATIONS ==========
        async function fetchNotifications() {
            try {
                const alerts = await supabaseQuery('system_health_log', 'check_name,status,message,checked_at,metadata', {
                    'check_name': 'eq.call_alert',
                    'order': 'checked_at.desc',
                    'limit': 10
                });

                const container = document.getElementById('notifFeed');
                document.getElementById('metricAlerts').textContent = alerts.length;
                document.getElementById('metricAlertsSub').textContent = alerts.length > 0 ? 'Call alerts' : 'No alerts yet';

                if (!alerts.length) {
                    container.innerHTML = '<div class="feed-item"><div class="feed-content"><div class="feed-desc" style="color: var(--text-muted)">No notifications yet</div></div></div>';
                    return;
                }

                container.innerHTML = alerts.map(a => {
                    const meta = a.metadata || {};
                    const caller = meta.caller_name || 'Unknown';
                    const phone = meta.caller_phone || '';
                    const summary = (meta.summary || a.message || '').substring(0, 100);

                    return `<div class="feed-item">
                        <div class="feed-icon alert">üîî</div>
                        <div class="feed-content">
                            <div class="feed-title">${escHtml(caller)} ${escHtml(phone)}</div>
                            <div class="feed-desc">${escHtml(summary)}</div>
                        </div>
                        <div class="feed-time">${timeAgo(a.checked_at)}</div>
                    </div>`;
                }).join('');

            } catch (e) {
                console.warn('Notifications fetch failed:', e);
            }
        }

        // ========== FETCH LEADS ==========
        async function fetchLeads() {
            try {
                const leads = await supabaseQuery('contacts_master',
                    'id,company,email,phone,status,lead_source,last_contacted_at,created_at', {
                    'order': 'created_at.desc',
                    'limit': 20
                });

                const tbody = document.getElementById('leadsTableBody');
                if (!leads.length) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: var(--text-muted); padding: 32px;">No leads found</td></tr>';
                    return;
                }

                const statusColors = {
                    new: 'tag-blue', research_done: 'tag-purple', outreach_sent: 'tag-amber',
                    responded: 'tag-green', customer: 'tag-green', bounced: 'tag-rose'
                };

                tbody.innerHTML = leads.map(l => `
                    <tr>
                        <td>
                            <div class="lead-name">${escHtml(l.company || 'Unknown')}</div>
                        </td>
                        <td>
                            <div class="lead-contact">${escHtml(l.email || '')}</div>
                            <div class="lead-contact">${escHtml(l.phone || '')}</div>
                        </td>
                        <td><span class="tag ${statusColors[l.status] || 'tag-blue'}">${escHtml(l.status || 'new')}</span></td>
                        <td style="color: var(--text-secondary); font-size: 12px;">${escHtml(l.lead_source || '‚Äî')}</td>
                        <td style="color: var(--text-secondary); font-size: 12px;">${l.last_contacted_at ? timeAgo(l.last_contacted_at) : '‚Äî'}</td>
                        <td style="color: var(--text-muted); font-size: 12px;">${l.created_at ? new Date(l.created_at).toLocaleDateString() : '‚Äî'}</td>
                    </tr>
                `).join('');

            } catch (e) {
                console.warn('Leads fetch failed:', e);
            }
        }

        // ========== ACTIONS ==========
        function triggerAction(action) {
            switch (action) {
                case 'call_sarah':
                    window.open('tel:+18632132505', '_self');
                    break;
                case 'system_health':
                    fetchStats();
                    alert('Health check triggered ‚Äî see dashboard for results.');
                    break;
                case 'view_logs':
                    window.open('https://modal.com/apps/nearmiss1193-afk/ghl-omni-automation', '_blank');
                    break;
            }
        }

        // ========== HELPERS ==========
        function escHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function timeAgo(dateStr) {
            if (!dateStr) return '';
            const diff = Date.now() - new Date(dateStr).getTime();
            const mins = Math.floor(diff / 60000);
            if (mins < 1) return 'now';
            if (mins < 60) return `${mins}m`;
            const hrs = Math.floor(mins / 60);
            if (hrs < 24) return `${hrs}h`;
            const days = Math.floor(hrs / 24);
            return `${days}d`;
        }

        // ========== INIT ==========
        function refreshAll() {
            fetchStats();
            fetchCalls();
            fetchActivity();
            fetchNotifications();
            fetchLeads();
        }

        function init() {
            updateClock();
            setInterval(updateClock, 1000);
            refreshAll();
            setInterval(refreshAll, 30000); // Refresh every 30s
        }

        checkSession();
    </script>
</body>

</html>