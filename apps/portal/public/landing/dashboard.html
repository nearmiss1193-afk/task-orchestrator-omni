<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Service Co ‚Äî Command Center</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-card: rgba(18, 18, 28, 0.8);
            --bg-card-hover: rgba(25, 25, 40, 0.9);
            --border: rgba(255, 255, 255, 0.06);
            --border-active: rgba(99, 102, 241, 0.4);
            --text-primary: #f0f0f5;
            --text-secondary: #8b8b9e;
            --text-muted: #55556a;
            --accent-blue: #6366f1;
            --accent-green: #10b981;
            --accent-amber: #f59e0b;
            --accent-rose: #f43f5e;
            --accent-purple: #a855f7;
            --accent-cyan: #06b6d4;
        }

        [data-theme="light"] {
            --bg-primary: #f5f5f9;
            --bg-card: rgba(255, 255, 255, 0.9);
            --bg-card-hover: rgba(245, 245, 250, 0.95);
            --border: rgba(0, 0, 0, 0.08);
            --border-active: rgba(99, 102, 241, 0.4);
            --text-primary: #1a1a2e;
            --text-secondary: #64648a;
            --text-muted: #9999aa;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background .3s, color .3s
        }

        body::before {
            content: '';
            position: fixed;
            inset: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(ellipse at 20% 50%, rgba(99, 102, 241, .04) 0%, transparent 50%), radial-gradient(ellipse at 80% 20%, rgba(168, 85, 247, .03) 0%, transparent 50%);
            z-index: 0;
            pointer-events: none
        }

        .app {
            position: relative;
            z-index: 1
        }

        /* Topbar */
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 28px;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(10, 10, 15, .85);
            transition: background .3s
        }

        [data-theme="light"] .topbar {
            background: rgba(245, 245, 249, .9)
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .topbar-logo {
            width: 34px;
            height: 34px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 15px
        }

        .topbar-title {
            font-weight: 700;
            font-size: 17px;
            letter-spacing: -.3px
        }

        .topbar-subtitle {
            font-size: 11px;
            color: var(--text-muted)
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            background: rgba(16, 185, 129, .1);
            border: 1px solid rgba(16, 185, 129, .2);
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-green)
        }

        .status-pill .dot {
            width: 7px;
            height: 7px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse-dot 2s infinite
        }

        .status-pill.degraded {
            background: rgba(245, 158, 11, .1);
            border-color: rgba(245, 158, 11, .2);
            color: var(--accent-amber)
        }

        .status-pill.degraded .dot {
            background: var(--accent-amber)
        }

        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .4
            }
        }

        .time-display {
            font-size: 11px;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums
        }

        .theme-toggle {
            background: none;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all .2s;
            color: var(--text-primary)
        }

        .theme-toggle:hover {
            border-color: var(--border-active);
            background: rgba(99, 102, 241, .08)
        }

        /* Main */
        .main {
            padding: 20px 28px;
            max-width: 1440px;
            margin: 0 auto
        }

        /* Metrics */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 14px;
            margin-bottom: 20px
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 18px;
            transition: all .3s;
            position: relative;
            overflow: hidden
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
            opacity: 0;
            transition: opacity .3s
        }

        .metric-card:hover {
            border-color: var(--border-active)
        }

        .metric-card:hover::before {
            opacity: 1
        }

        .metric-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 6px
        }

        .metric-value {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -1px;
            line-height: 1
        }

        .metric-sub {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px
        }

        .metric-icon {
            position: absolute;
            top: 14px;
            right: 14px;
            font-size: 18px;
            opacity: .4
        }

        .sparkline {
            margin-top: 8px;
            height: 28px
        }

        .sparkline svg {
            width: 100%;
            height: 28px
        }

        .sparkline path {
            fill: none;
            stroke: var(--accent-blue);
            stroke-width: 1.5;
            stroke-linecap: round
        }

        .sparkline .area {
            fill: url(#sparkGrad);
            stroke: none
        }

        /* Grid layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 20px
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 14px;
            margin-bottom: 20px
        }

        /* Panel */
        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background .3s, border .3s
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            border-bottom: 1px solid var(--border)
        }

        .panel-title {
            font-size: 13px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .panel-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 999px;
            background: rgba(99, 102, 241, .15);
            color: var(--accent-blue)
        }

        .panel-body {
            padding: 14px 18px;
            flex: 1;
            overflow-y: auto;
            max-height: 380px
        }

        /* Feed */
        .feed-item {
            display: flex;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            transition: background .2s;
            cursor: pointer;
            border-radius: 6px
        }

        .feed-item:hover {
            background: rgba(255, 255, 255, .02)
        }

        .feed-item:last-child {
            border-bottom: none
        }

        .feed-icon {
            width: 34px;
            height: 34px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            flex-shrink: 0
        }

        .feed-icon.call {
            background: rgba(99, 102, 241, .15)
        }

        .feed-icon.sms {
            background: rgba(16, 185, 129, .15)
        }

        .feed-icon.email {
            background: rgba(245, 158, 11, .15)
        }

        .feed-icon.alert {
            background: rgba(244, 63, 94, .15)
        }

        .feed-icon.system {
            background: rgba(168, 85, 247, .15)
        }

        .feed-content {
            flex: 1;
            min-width: 0
        }

        .feed-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 1px
        }

        .feed-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        .feed-time {
            font-size: 10px;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
            flex-shrink: 0;
            margin-top: 2px
        }

        /* Transcript expand */
        .feed-transcript {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background: rgba(0, 0, 0, .2);
            border-radius: 8px;
            font-size: 11px;
            line-height: 1.6;
            color: var(--text-secondary);
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid var(--border)
        }

        .feed-item.expanded .feed-transcript {
            display: block
        }

        .feed-item.expanded .feed-desc {
            white-space: normal
        }

        /* Audio player */
        .feed-audio {
            margin-top: 6px
        }

        .feed-audio audio {
            width: 100%;
            height: 28px;
            border-radius: 6px
        }

        /* Lead actions */
        .lead-actions {
            display: flex;
            gap: 4px
        }

        .lead-action-btn {
            padding: 4px 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: none;
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            white-space: nowrap
        }

        .lead-action-btn:hover {
            border-color: var(--border-active);
            color: var(--accent-blue);
            background: rgba(99, 102, 241, .08)
        }

        .lead-action-btn.sms {
            color: var(--accent-green)
        }

        .lead-action-btn.sms:hover {
            border-color: rgba(16, 185, 129, .4);
            background: rgba(16, 185, 129, .08)
        }

        .lead-action-btn.email {
            color: var(--accent-amber)
        }

        .lead-action-btn.email:hover {
            border-color: rgba(245, 158, 11, .4);
            background: rgba(245, 158, 11, .08)
        }

        /* Integration */
        .integration-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px
        }

        .integration-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, .02);
            border-radius: 9px;
            border: 1px solid var(--border)
        }

        .integration-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            flex-shrink: 0
        }

        .integration-dot.green {
            background: var(--accent-green);
            box-shadow: 0 0 8px rgba(16, 185, 129, .4)
        }

        .integration-dot.amber {
            background: var(--accent-amber);
            box-shadow: 0 0 8px rgba(245, 158, 11, .4)
        }

        .integration-dot.red {
            background: var(--accent-rose);
            box-shadow: 0 0 8px rgba(244, 63, 94, .4)
        }

        .integration-name {
            font-size: 12px;
            font-weight: 600
        }

        .integration-status {
            font-size: 10px;
            color: var(--text-muted)
        }

        /* Action buttons */
        .action-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 12px 14px;
            background: rgba(255, 255, 255, .03);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            text-align: left
        }

        .action-btn:hover {
            background: rgba(99, 102, 241, .08);
            border-color: var(--border-active);
            transform: translateY(-1px)
        }

        .action-btn .icon {
            width: 34px;
            height: 34px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            flex-shrink: 0
        }

        .action-btn .label-sub {
            font-size: 10px;
            color: var(--text-muted);
            font-weight: 400
        }

        /* Campaign control */
        .campaign-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border)
        }

        .campaign-row:last-child {
            border-bottom: none
        }

        .campaign-toggle {
            position: relative;
            width: 40px;
            height: 22px;
            background: rgba(255, 255, 255, .1);
            border-radius: 11px;
            cursor: pointer;
            transition: background .2s;
            border: none
        }

        .campaign-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform .2s
        }

        .campaign-toggle.active {
            background: var(--accent-green)
        }

        .campaign-toggle.active::after {
            transform: translateX(18px)
        }

        /* Table */
        .leads-table {
            width: 100%;
            border-collapse: collapse
        }

        .leads-table thead th {
            text-align: left;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: .8px;
            color: var(--text-muted);
            font-weight: 600;
            padding: 8px 14px;
            border-bottom: 1px solid var(--border)
        }

        .leads-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background .2s
        }

        .leads-table tbody tr:hover {
            background: rgba(255, 255, 255, .02)
        }

        .leads-table td {
            padding: 10px 14px;
            font-size: 12px
        }

        .lead-name {
            font-weight: 600
        }

        .lead-contact {
            color: var(--text-secondary);
            font-size: 11px
        }

        .tag {
            display: inline-block;
            padding: 2px 7px;
            border-radius: 5px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .4px
        }

        .tag-blue {
            background: rgba(99, 102, 241, .15);
            color: #818cf8
        }

        .tag-green {
            background: rgba(16, 185, 129, .15);
            color: #34d399
        }

        .tag-amber {
            background: rgba(245, 158, 11, .15);
            color: #fbbf24
        }

        .tag-rose {
            background: rgba(244, 63, 94, .15);
            color: #fb7185
        }

        .tag-purple {
            background: rgba(168, 85, 247, .15);
            color: #c084fc
        }

        /* Revenue card */
        .revenue-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border)
        }

        .revenue-row:last-child {
            border-bottom: none
        }

        .revenue-label {
            font-size: 12px;
            color: var(--text-secondary)
        }

        .revenue-val {
            font-size: 14px;
            font-weight: 700
        }

        /* Map */
        .heatmap-container {
            width: 100%;
            height: 200px;
            background: rgba(255, 255, 255, .02);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border)
        }

        .map-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-blue);
            opacity: .6;
            animation: map-pulse 3s infinite
        }

        @keyframes map-pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: .6
            }

            50% {
                transform: scale(1.8);
                opacity: .2
            }
        }

        /* Auth */
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 15, .95);
            backdrop-filter: blur(30px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .auth-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 36px;
            max-width: 360px;
            width: 100%;
            text-align: center
        }

        .auth-box h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px
        }

        .auth-box p {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 20px
        }

        .auth-input {
            width: 100%;
            background: rgba(255, 255, 255, .04);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            color: var(--text-primary);
            font-size: 16px;
            text-align: center;
            letter-spacing: 4px;
            font-family: 'Inter';
            outline: none;
            transition: border .2s;
            margin-bottom: 14px
        }

        .auth-input:focus {
            border-color: var(--accent-blue)
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: opacity .2s
        }

        .auth-btn:hover {
            opacity: .9
        }

        .auth-error {
            color: var(--accent-rose);
            font-size: 11px;
            margin-top: 10px;
            display: none
        }

        /* Notif toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 200;
            background: var(--bg-card);
            border: 1px solid var(--accent-blue);
            border-radius: 12px;
            padding: 14px 18px;
            max-width: 360px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, .4);
            transform: translateX(120%);
            transition: transform .4s cubic-bezier(.2, 1, .3, 1);
            backdrop-filter: blur(20px)
        }

        .toast.show {
            transform: translateX(0)
        }

        .toast-title {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 2px
        }

        .toast-body {
            font-size: 11px;
            color: var(--text-secondary)
        }

        /* Responsive */
        @media(max-width:1024px) {
            .metrics-row {
                grid-template-columns: repeat(3, 1fr)
            }

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr
            }

            .topbar,
            .main {
                padding-left: 16px;
                padding-right: 16px
            }
        }

        @media(max-width:640px) {
            .metrics-row {
                grid-template-columns: repeat(2, 1fr)
            }

            .integration-grid {
                grid-template-columns: repeat(2, 1fr)
            }
        }

        ::-webkit-scrollbar {
            width: 4px
        }

        ::-webkit-scrollbar-track {
            background: transparent
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .1);
            border-radius: 4px
        }

        .refresh-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 11px;
            padding: 3px 7px;
            border-radius: 5px;
            transition: all .2s
        }

        .refresh-btn:hover {
            color: var(--accent-blue);
            background: rgba(99, 102, 241, .1)
        }

        /* Command Bar */
        .cmd-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:150;display:none;align-items:flex-start;justify-content:center;padding-top:20vh}
        .cmd-overlay.open{display:flex}
        .cmd-box{background:var(--bg-card);border:1px solid var(--border-active);border-radius:16px;width:100%;max-width:520px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.5)}
        .cmd-input-wrap{display:flex;align-items:center;padding:14px 18px;gap:10px;border-bottom:1px solid var(--border)}
        .cmd-input-wrap .icon{font-size:16px;color:var(--text-muted)}
        .cmd-input{flex:1;background:none;border:none;color:var(--text-primary);font-size:14px;font-family:'Inter';outline:none}
        .cmd-input::placeholder{color:var(--text-muted)}
        .cmd-kbd{font-size:10px;color:var(--text-muted);background:rgba(255,255,255,.06);padding:2px 6px;border-radius:4px;font-family:'Inter'}
        .cmd-results{max-height:300px;overflow-y:auto;padding:6px}
        .cmd-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;cursor:pointer;transition:background .15s;font-size:13px}
        .cmd-item:hover,.cmd-item.active{background:rgba(99,102,241,.1)}
        .cmd-item .ci-icon{font-size:16px;width:28px;text-align:center}
        .cmd-item .ci-label{flex:1;font-weight:500}
        .cmd-item .ci-hint{font-size:10px;color:var(--text-muted)}
        .cmd-empty{padding:20px;text-align:center;color:var(--text-muted);font-size:12px}
    </style>
</head>

<body>
    <!-- COMMAND BAR -->
    <div id="cmdOverlay" class="cmd-overlay" onclick="if(event.target===this)closeCmd()">
        <div class="cmd-box">
            <div class="cmd-input-wrap"><span class="icon">üîç</span><input type="text" id="cmdInput" class="cmd-input" placeholder="Search leads, run commands..." oninput="filterCmd()"><span class="cmd-kbd">ESC</span></div>
            <div class="cmd-results" id="cmdResults"></div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="toast">
        <div class="toast-title" id="toastTitle"></div>
        <div class="toast-body" id="toastBody"></div>
    </div>

    <!-- AUTH GATE -->
    <div id="authGate" class="auth-overlay">
        <div class="auth-box">
            <div style="font-size:28px;margin-bottom:14px">‚ö°</div>
            <h2>Command Center</h2>
            <p>Enter access code</p>
            <input type="password" id="authInput" class="auth-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autofocus>
            <button onclick="authenticate()" class="auth-btn">Authenticate</button>
            <div id="authError" class="auth-error">Access denied</div>
        </div>
    </div>

    <div class="app">
        <header class="topbar">
            <div class="topbar-left">
                <div class="topbar-logo">A</div>
                <div>
                    <div class="topbar-title">AI Service Co</div>
                    <div class="topbar-subtitle">Command Center v3</div>
                </div>
            </div>
            <div class="topbar-right">
                <div class="time-display" id="clockDisplay">--:--</div>
                <div class="status-pill" id="systemStatus">
                    <div class="dot"></div><span id="systemStatusText">Connecting...</span>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme" id="themeBtn">üåô</button>
                <button class="refresh-btn" onclick="refreshAll()">‚Üª Refresh</button>
            </div>
        </header>

        <main class="main">
            <!-- SVG gradient def for sparklines -->
            <svg width="0" height="0">
                <defs>
                    <linearGradient id="sparkGrad" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="rgba(99,102,241,0.3)" />
                        <stop offset="100%" stop-color="rgba(99,102,241,0)" />
                    </linearGradient>
                </defs>
            </svg>

            <!-- METRICS -->
            <div class="metrics-row">
                <div class="metric-card">
                    <div class="metric-icon">üë•</div>
                    <div class="metric-label">Total Leads</div>
                    <div class="metric-value" id="mLeads">‚Äî</div>
                    <div class="metric-sub" id="mLeadsSub">Loading...</div>
                    <div class="sparkline" id="sparkLeads"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üì§</div>
                    <div class="metric-label">Outreach 24h</div>
                    <div class="metric-value" id="mOutreach">‚Äî</div>
                    <div class="metric-sub" id="mOutreachSub">Loading...</div>
                    <div class="sparkline" id="sparkOutreach"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üìû</div>
                    <div class="metric-label">AI Calls</div>
                    <div class="metric-value" id="mCalls">‚Äî</div>
                    <div class="metric-sub" id="mCallsSub">Loading...</div>
                    <div class="sparkline" id="sparkCalls"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üí∞</div>
                    <div class="metric-label">Pipeline</div>
                    <div class="metric-value" id="mPipeline">‚Äî</div>
                    <div class="metric-sub">$49-99/mo per client</div>
                    <div class="sparkline" id="sparkRevenue"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üîî</div>
                    <div class="metric-label">Alerts Today</div>
                    <div class="metric-value" id="mAlerts">‚Äî</div>
                    <div class="metric-sub" id="mAlertsSub">Loading...</div>
                </div>
            </div>

            <!-- LIVE FEED + CALLS -->
            <div class="grid-2">
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span>üì°</span> Live Activity <span class="panel-badge"
                                id="feedCount">0</span></div><button class="refresh-btn"
                            onclick="fetchActivity()">‚Üª</button>
                    </div>
                    <div class="panel-body" id="activityFeed">
                        <div style="color:var(--text-muted);font-size:11px;padding:20px 0;text-align:center">Loading...
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span>üìû</span> Recent Calls <span class="panel-badge"
                                id="callCount">0</span></div><button class="refresh-btn"
                            onclick="fetchCalls()">‚Üª</button>
                    </div>
                    <div class="panel-body" id="callsFeed">
                        <div style="color:var(--text-muted);font-size:11px;padding:20px 0;text-align:center">Loading...
                        </div>
                    </div>
                </div>
            </div>

            <!-- INTEGRATIONS + CAMPAIGNS + NOTIFICATIONS -->
            <div class="grid-3">
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span>üîó</span> Integrations</div>
                    </div>
                    <div class="panel-body">
                        <div class="integration-grid">
                            <div class="integration-item">
                                <div class="integration-dot green" id="intModal"></div>
                                <div>
                                    <div class="integration-name">Modal</div>
                                    <div class="integration-status" id="intModalSt">Checking...</div>
                                </div>
                            </div>
                            <div class="integration-item">
                                <div class="integration-dot green"></div>
                                <div>
                                    <div class="integration-name">Vapi</div>
                                    <div class="integration-status">Sarah Online</div>
                                </div>
                            </div>
                            <div class="integration-item">
                                <div class="integration-dot green" id="intGHL"></div>
                                <div>
                                    <div class="integration-name">GHL</div>
                                    <div class="integration-status" id="intGHLSt">Connected</div>
                                </div>
                            </div>
                            <div class="integration-item">
                                <div class="integration-dot green"></div>
                                <div>
                                    <div class="integration-name">Resend</div>
                                    <div class="integration-status">Email Ready</div>
                                </div>
                            </div>
                            <div class="integration-item">
                                <div class="integration-dot green" id="intDB"></div>
                                <div>
                                    <div class="integration-name">Supabase</div>
                                    <div class="integration-status" id="intDBSt">Connected</div>
                                </div>
                            </div>
                            <div class="integration-item">
                                <div class="integration-dot green" id="intHB"></div>
                                <div>
                                    <div class="integration-name">Heartbeat</div>
                                    <div class="integration-status" id="intHBSt">Checking...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campaign Control -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span>üéØ</span> Campaigns</div>
                    </div>
                    <div class="panel-body">
                        <div class="campaign-row">
                            <div>
                                <div style="font-size:12px;font-weight:600">Email Outreach</div>
                                <div style="font-size:10px;color:var(--text-muted)">Auto campaign processor</div>
                            </div><button class="campaign-toggle active" id="togEmail"
                                onclick="toggleCampaign(this)"></button>
                        </div>
                        <div class="campaign-row">
                            <div>
                                <div style="font-size:12px;font-weight:600">Voice Drops</div>
                                <div style="font-size:10px;color:var(--text-muted)">Slybroadcast blasts</div>
                            </div><button class="campaign-toggle" id="togVoice" onclick="toggleCampaign(this)"></button>
                        </div>
                        <div class="campaign-row">
                            <div>
                                <div style="font-size:12px;font-weight:600">SMS Follow-up</div>
                                <div style="font-size:10px;color:var(--text-muted)">GHL auto-reply</div>
                            </div><button class="campaign-toggle" id="togSMS" onclick="toggleCampaign(this)"></button>
                        </div>
                        <div class="campaign-row">
                            <div>
                                <div style="font-size:12px;font-weight:600">Sarah Inbound</div>
                                <div style="font-size:10px;color:var(--text-muted)">AI receptionist</div>
                            </div><button class="campaign-toggle active" id="togSarah"
                                onclick="toggleCampaign(this)"></button>
                        </div>
                    </div>
                </div>

                <!-- Notifications -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span>üîî</span> Notifications</div><button class="refresh-btn"
                            onclick="fetchNotifications()">‚Üª</button>
                    </div>
                    <div class="panel-body" id="notifFeed">
                        <div style="color:var(--text-muted);font-size:11px;padding:20px 0;text-align:center">Loading...
                        </div>
                    </div>
                </div>
            </div>

            <!-- REVENUE + MAP -->
            <div class="grid-2">
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span>üí∞</span> Revenue Tracker</div>
                    </div>
                    <div class="panel-body">
                        <div class="revenue-row">
                            <div class="revenue-label">Trial Signups</div>
                            <div class="revenue-val" id="revTrials">‚Äî</div>
                        </div>
                        <div class="revenue-row">
                            <div class="revenue-label">Active Subscribers</div>
                            <div class="revenue-val" id="revActive" style="color:var(--accent-green)">‚Äî</div>
                        </div>
                        <div class="revenue-row">
                            <div class="revenue-label">Monthly Recurring</div>
                            <div class="revenue-val" id="revMRR" style="color:var(--accent-blue)">‚Äî</div>
                        </div>
                        <div class="revenue-row">
                            <div class="revenue-label">Grandfathered ($49)</div>
                            <div class="revenue-val" id="revGrand">‚Äî</div>
                        </div>
                        <div class="revenue-row">
                            <div class="revenue-label">Full Price ($99)</div>
                            <div class="revenue-val" id="revFull">‚Äî</div>
                        </div>
                        <div class="revenue-row">
                            <div class="revenue-label">Churn Rate</div>
                            <div class="revenue-val" id="revChurn" style="color:var(--accent-rose)">‚Äî</div>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span>üó∫Ô∏è</span> Lead Heatmap ‚Äî Florida</div>
                    </div>
                    <div class="panel-body" style="padding:10px">
                        <div class="heatmap-container" id="heatmapContainer"></div>
                    </div>
                </div>
            </div>

            <!-- LEADS TABLE -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><span>üë•</span> Lead Pipeline</div><button class="refresh-btn"
                        onclick="fetchLeads()">‚Üª</button>
                </div>
                <div style="overflow-x:auto">
                    <table class="leads-table">
                        <thead>
                            <tr>
                                <th>Business</th>
                                <th>Contact</th>
                                <th>Status</th>
                                <th>Source</th>
                                <th>Last Touch</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leadsBody">
                            <tr>
                                <td colspan="6" style="text-align:center;color:var(--text-muted);padding:28px">
                                    Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const MODAL_URL = 'https://nearmiss1193-afk--ghl-omni-automation';
        const STATS_URL = `${MODAL_URL}-sovereign-stats.modal.run`;
        const SB_URL = 'https://rzcpfwkygdvoshtwxncs.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ6Y3Bmd2t5Z2R2b3NodHd4bmNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1OTA0MjQsImV4cCI6MjA4MjE2NjQyNH0.tWtGxrb4mZxjJggwKTkLpLk2GBi4d_zyUUq1nJMFnkk';
        const GATE_KEY = 'CMD_V3'; const SESSION_CODE = 'SOVEREIGN';
        const DAN_PHONE = '+13529368152'; const SARAH_PHONE = '+18632132505';
        const GHL_WEBHOOK = 'https://services.leadconnectorhq.com/hooks/RnK4OjX0oDcqtWw0VyLr/webhook-trigger/0c38f94b-57ca-4e27-94cf-4d75b55602cd';

        // AUTH
        function checkSession() { if (localStorage.getItem(GATE_KEY) === 'OK') { document.getElementById('authGate').style.display = 'none'; init() } }
        function authenticate() { const i = document.getElementById('authInput'); if (i.value === SESSION_CODE) { localStorage.setItem(GATE_KEY, 'OK'); document.getElementById('authGate').style.display = 'none'; init() } else { document.getElementById('authError').style.display = 'block'; i.value = ''; i.style.borderColor = 'var(--accent-rose)'; setTimeout(() => i.style.borderColor = '', 2000) } }
        document.getElementById('authInput').addEventListener('keypress', e => { if (e.key === 'Enter') authenticate() });

        // CLOCK
        function updateClock() { document.getElementById('clockDisplay').textContent = new Date().toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true, timeZone: 'America/New_York' }) + ' ET' }

        // THEME
        function toggleTheme() { const h = document.documentElement; const dark = h.dataset.theme === 'dark'; h.dataset.theme = dark ? 'light' : 'dark'; document.getElementById('themeBtn').textContent = dark ? '‚òÄÔ∏è' : 'üåô'; localStorage.setItem('theme', h.dataset.theme) }
        if (localStorage.getItem('theme') === 'light') { document.documentElement.dataset.theme = 'light'; document.getElementById('themeBtn').textContent = '‚òÄÔ∏è' }

        // PUSH NOTIFICATIONS
        let pushEnabled = false;
        async function enablePush() { if (!('Notification' in window)) return; const p = await Notification.requestPermission(); pushEnabled = p === 'granted'; if (pushEnabled) showToast('üîî Push Enabled', 'You will receive browser alerts for incoming calls') }
        function sendPush(title, body) { if (!pushEnabled) return; try { new Notification(title, { body, icon: '‚ö°', badge: 'üìû' }) } catch (e) { console.warn('Push failed:', e) } }

        // TOAST
        function showToast(title, body) { const t = document.getElementById('toast'); document.getElementById('toastTitle').textContent = title; document.getElementById('toastBody').textContent = body; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 5000) }

        // SPARKLINE
        function renderSparkline(containerId, data) { const el = document.getElementById(containerId); if (!el || !data.length) return; const w = el.clientWidth || 120, h = 28; const max = Math.max(...data), min = Math.min(...data); const range = max - min || 1; const pts = data.map((v, i) => [i * (w / (data.length - 1)), h - (((v - min) / range) * h * .8 + h * .1)]); const line = pts.map((p, i) => i === 0 ? `M${p[0]},${p[1]}` : `L${p[0]},${p[1]}`).join(' '); const area = line + ` L${w},${h} L0,${h} Z`; el.innerHTML = `<svg viewBox="0 0 ${w} ${h}"><path class="area" d="${area}"/><path d="${line}"/></svg>` }

        // SUPABASE QUERY
        async function sbQuery(table, select = '*', params = {}) { let url = `${SB_URL}/rest/v1/${table}?select=${encodeURIComponent(select)}`; for (const [k, v] of Object.entries(params)) if (k[0] !== '_') url += `&${k}=${encodeURIComponent(v)}`; const res = await fetch(url, { headers: { apikey: SB_KEY, Authorization: `Bearer ${SB_KEY}` } }); return res.json() }

        // HELPERS
        function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML }
        function ago(d) { if (!d) return ''; const m = Math.floor((Date.now() - new Date(d).getTime()) / 60000); if (m < 1) return 'now'; if (m < 60) return m + 'm'; const h = Math.floor(m / 60); if (h < 24) return h + 'h'; return Math.floor(h / 24) + 'd' }

        // UNIFIED FETCH ‚Äî single Modal API call, bypasses RLS
        let prevCallCount = 0;
        let dashData = null;

        async function fetchAll() {
            try {
                const r = await fetch(STATS_URL, { signal: AbortSignal.timeout(12000) });
                dashData = await r.json();
                if (dashData.error) throw new Error(dashData.error);

                // === METRICS ===
                document.getElementById('mLeads').textContent = (dashData.total_leads || 0).toLocaleString();
                document.getElementById('mLeadsSub').textContent = 'Contactable pool';
                document.getElementById('mOutreach').textContent = (dashData.outbound_24h || 0).toLocaleString();
                document.getElementById('mOutreachSub').textContent = 'Emails, SMS, calls';
                document.getElementById('mPipeline').textContent = '$' + ((dashData.total_leads || 0) * 49).toLocaleString();
                const ok = dashData.health?.status === 'healthy';
                document.getElementById('systemStatusText').textContent = ok ? 'All Systems Online' : 'Degraded';
                document.getElementById('systemStatus').className = ok ? 'status-pill' : 'status-pill degraded';
                document.getElementById('intModalSt').textContent = 'Deployed';
                document.getElementById('intHB').className = `integration-dot ${ok ? 'green' : 'amber'}`;
                if (dashData.health?.last_heartbeat) {
                    const a = Math.round((Date.now() - new Date(dashData.health.last_heartbeat).getTime()) / 60000);
                    document.getElementById('intHBSt').textContent = a + 'm ago';
                }
                renderSparkline('sparkLeads', [280, 295, 310, 305, 320, 335, dashData.total_leads || 340]);
                renderSparkline('sparkOutreach', [12, 8, 15, 22, 18, 25, dashData.outbound_24h || 20]);
                renderSparkline('sparkRevenue', [8000, 9200, 10500, 11000, 12800, 14200, (dashData.total_leads || 0) * 49]);

                // === ACTIVITY FEED ===
                const activity = dashData.activity || [];
                const actEl = document.getElementById('activityFeed');
                document.getElementById('feedCount').textContent = activity.length;
                if (!activity.length) { actEl.innerHTML = '<div style="color:var(--text-muted);font-size:11px;padding:20px 0;text-align:center">No activity</div>'; }
                else {
                    const icons = { email: 'üìß', sms: 'üí¨', call: 'üìû', social: 'üåê', voice_drop: 'üîä' };
                    const clsMap = { email: 'email', sms: 'sms', call: 'call', social: 'system', voice_drop: 'alert' };
                    actEl.innerHTML = activity.map(x => `<div class="feed-item"><div class="feed-icon ${clsMap[x.channel] || 'system'}">${icons[x.channel] || 'üì§'}</div><div class="feed-content"><div class="feed-title">${esc(x.company || 'Unknown')}</div><div class="feed-desc">${esc(x.channel || '')} ‚Äî ${esc(x.status || '')}</div></div><div class="feed-time">${ago(x.ts)}</div></div>`).join('');
                }

                // === CALLS ===
                const calls = dashData.calls || [];
                const callEl = document.getElementById('callsFeed');
                document.getElementById('callCount').textContent = calls.length;
                document.getElementById('mCalls').textContent = calls.length;
                document.getElementById('mCallsSub').textContent = 'In memory bank';
                if (calls.length > prevCallCount && prevCallCount > 0) {
                    const n = calls[0]; const ctx = typeof n.context_summary === 'string' ? { history: n.context_summary } : (n.context_summary || {});
                    sendPush('üìû New Call!', `${ctx.contact_name || 'Unknown'} ‚Äî ${n.phone_number}`);
                    showToast('üìû Incoming Call', `${ctx.contact_name || 'Unknown'} from ${n.phone_number}`);
                }
                prevCallCount = calls.length;
                renderSparkline('sparkCalls', [3, 5, 4, 7, 6, 8, calls.length]);
                if (!calls.length) { callEl.innerHTML = '<div style="color:var(--text-muted);font-size:11px;padding:20px 0;text-align:center">No calls</div>'; }
                else {
                    callEl.innerHTML = calls.map(cl => {
                        const ctx = typeof cl.context_summary === 'string' ? { history: cl.context_summary } : (cl.context_summary || {});
                        const name = ctx.contact_name || 'Unknown';
                        const hist = (ctx.history || '').split('\n').filter(Boolean);
                        const last = hist[hist.length - 1] || 'No details';
                        const full = hist.join('\n');
                        return `<div class="feed-item" onclick="this.classList.toggle('expanded')"><div class="feed-icon call">üìû</div><div class="feed-content"><div class="feed-title">${esc(name)} ‚Äî ${esc(cl.phone_number)}</div><div class="feed-desc">${esc(last.substring(0, 120))}</div><div class="feed-transcript">${esc(full)}</div></div><div class="feed-time">${ago(cl.updated_at)}</div></div>`;
                    }).join('');
                }

                // === NOTIFICATIONS ===
                const notifs = dashData.notifications || [];
                const notifEl = document.getElementById('notifFeed');
                document.getElementById('mAlerts').textContent = notifs.length;
                document.getElementById('mAlertsSub').textContent = notifs.length ? 'Call alerts' : 'No alerts';
                if (!notifs.length) { notifEl.innerHTML = '<div style="color:var(--text-muted);font-size:11px;padding:20px 0;text-align:center">No notifications</div>'; }
                else {
                    notifEl.innerHTML = notifs.map(n => {
                        const m = n.metadata || {};
                        return `<div class="feed-item" onclick="this.classList.toggle('expanded')"><div class="feed-icon alert">üîî</div><div class="feed-content"><div class="feed-title">${esc(m.caller_name || 'Unknown')} ${esc(m.caller_phone || '')}</div><div class="feed-desc">${esc((m.summary || n.message || '').substring(0, 100))}</div><div class="feed-transcript">${esc(m.transcript || m.summary || 'No details')}</div></div><div class="feed-time">${ago(n.checked_at)}</div></div>`;
                    }).join('');
                }

                // === LEADS TABLE ===
                const leads = dashData.leads || [];
                const tb = document.getElementById('leadsBody');
                if (!leads.length) { tb.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:28px">No leads</td></tr>'; }
                else {
                    const sc = { new: 'tag-blue', research_done: 'tag-purple', outreach_sent: 'tag-amber', responded: 'tag-green', customer: 'tag-green', bounced: 'tag-rose' };
                    tb.innerHTML = leads.map(l => `<tr><td><div class="lead-name">${esc(l.company || 'Unknown')}</div></td><td><div class="lead-contact">${esc(l.email || '')}</div><div class="lead-contact">${esc(l.phone || '')}</div></td><td><span class="tag ${sc[l.status] || 'tag-blue'}">${esc(l.status || 'new')}</span></td><td style="color:var(--text-secondary);font-size:11px">${esc(l.lead_source || '‚Äî')}</td><td style="color:var(--text-secondary);font-size:11px">${l.last_contacted_at ? ago(l.last_contacted_at) : '‚Äî'}</td><td><div class="lead-actions"><button class="lead-action-btn" title="Call" onclick="event.stopPropagation();window.open('tel:${l.phone || ''}')">üìû</button><button class="lead-action-btn sms" title="SMS" onclick="event.stopPropagation();sendQuickSMS('${l.phone || ''}','${esc(l.company || '')}')">üí¨</button><button class="lead-action-btn email" title="Email" onclick="event.stopPropagation();window.open('mailto:${l.email || ''}')">üìß</button></div></td></tr>`).join('');
                }

            } catch (e) {
                console.warn('API Error:', e);
                document.getElementById('systemStatusText').textContent = 'API Offline';
                document.getElementById('systemStatus').className = 'status-pill degraded';
                document.getElementById('intModal').className = 'integration-dot red';
                document.getElementById('intModalSt').textContent = 'Offline';
            }
        }

        // Individual refresh proxies (all call fetchAll)
        function fetchStats() { fetchAll(); }
        function fetchCalls() { fetchAll(); }
        function fetchActivity() { fetchAll(); }
        function fetchNotifications() { fetchAll(); }
        function fetchLeads() { fetchAll(); }

        // INIT
        function refreshAll() { fetchAll(); updateRevenue(); renderHeatmap() }
        function init() { updateClock(); setInterval(updateClock, 1000); enablePush(); refreshAll(); setInterval(refreshAll, 30000); registerSW(); }
        checkSession();

        // === CMD+K COMMAND BAR ===
        const CMD_ACTIONS = [
            { icon: 'üè•', label: 'Run Health Check', hint: 'System diagnostics', action: () => { fetchAll(); showToast('üè• Health Check', 'Running...'); } },
            { icon: 'üìä', label: 'Open Modal Logs', hint: 'View cloud logs', action: () => window.open('https://modal.com/apps/nearmiss1193-afk/ghl-omni-automation', '_blank') },
            { icon: 'üìû', label: 'Call Sarah', hint: SARAH_PHONE, action: () => window.open(`tel:${SARAH_PHONE}`) },
            { icon: '‚Üª', label: 'Force Refresh', hint: 'Reload all data', action: () => { refreshAll(); showToast('‚Üª Refreshed', 'All panels updated'); } },
            { icon: 'üåô', label: 'Toggle Theme', hint: 'Dark/Light mode', action: () => toggleTheme() },
            { icon: 'üë•', label: 'Client Portal', hint: 'Open client view', action: () => window.open('client-dashboard.html', '_blank') },
        ];

        function openCmd() { document.getElementById('cmdOverlay').classList.add('open'); document.getElementById('cmdInput').value = ''; document.getElementById('cmdInput').focus(); filterCmd(); }
        function closeCmd() { document.getElementById('cmdOverlay').classList.remove('open'); }

        function filterCmd() {
            const q = document.getElementById('cmdInput').value.toLowerCase();
            const res = document.getElementById('cmdResults');
            let items = [];

            // Built-in actions
            CMD_ACTIONS.forEach(a => { if (!q || a.label.toLowerCase().includes(q)) items.push(a); });

            // Search leads from cached data
            if (dashData && dashData.leads && q.length > 1) {
                dashData.leads.filter(l => (l.company || '').toLowerCase().includes(q) || (l.email || '').toLowerCase().includes(q)).slice(0, 5).forEach(l => {
                    items.push({ icon: 'üë§', label: esc(l.company || 'Unknown'), hint: esc(l.email || l.phone || ''), action: () => { if (l.phone) sendQuickSMS(l.phone, l.company); else if (l.email) window.open(`mailto:${l.email}`); } });
                });
            }

            if (!items.length) { res.innerHTML = '<div class="cmd-empty">No results</div>'; return; }
            res.innerHTML = items.map((it, i) => `<div class="cmd-item${i === 0 ? ' active' : ''}" onclick="cmdRun(${i})" data-idx="${i}"><span class="ci-icon">${it.icon}</span><span class="ci-label">${it.label}</span><span class="ci-hint">${it.hint || ''}</span></div>`).join('');
            window._cmdItems = items;
        }

        function cmdRun(idx) { if (window._cmdItems && window._cmdItems[idx]) { window._cmdItems[idx].action(); closeCmd(); } }

        // Keyboard shortcuts
        document.addEventListener('keydown', e => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); openCmd(); }
            if (e.key === 'Escape') closeCmd();
            if (document.getElementById('cmdOverlay').classList.contains('open') && e.key === 'Enter') {
                const active = document.querySelector('.cmd-item.active');
                if (active) cmdRun(parseInt(active.dataset.idx));
            }
        });

        // === PWA SERVICE WORKER ===
        function registerSW() { if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').then(r => console.log('SW registered:', r.scope)).catch(e => console.warn('SW failed:', e)); }
    </script>
</body>

</html>