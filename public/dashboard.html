<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Vapi SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@vapi-ai/web@latest/dist/vapi.min.js"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            background-color: #020617;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8080RNWHVV">
    </script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-8080RNWHVV');
    </script>
</head>

<body class="p-8 overflow-x-hidden">
    <!-- CONFIG -->
    <script>
        // SOVEREIGN CREDENTIALS (Client-Side Safe for Dashboard)
        const SUPABASE_URL = "https://rzcpfwkygdvoshtwxncs.supabase.co";
        // Verified Anon Key (2026-01-09 - FRESH from Supabase dashboard)
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ6Y3Bmd2t5Z2R2b3NodHd4bmNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1OTA0MjQsImV4cCI6MjA4MjE2NjQyNH0.dluuiK-jr-3Z_oksYHS4saSthpkppLHQGnl6YtploPU";

        // VAPI
        const VAPI_PUBLIC_KEY = "3b065ff0-a721-4b66-8255-30b6b8d6daab";
        // "John" as the Orchestrator
        const ORCHESTRATOR_ID = "78b4c14a-4db3-4416-9289-d1bfd2409606";

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const vapi = new window.vapi(VAPI_PUBLIC_KEY);
    </script>

    <div class="max-w-7xl mx-auto">

        <!-- Header -->
        <nav class="glass rounded-2xl p-4 mb-6 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-xl">‚ö°</div>
                <div>
                    <h1 class="font-bold text-xl">Sovereign Command</h1>
                    <div class="text-xs text-green-400">‚óè Systems Online</div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.open('https://app.gohighlevel.com')"
                    class="px-4 py-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition text-sm">Targeting
                    (GHL)</button>
                <button onclick="window.open('https://dashboard.vapi.ai')"
                    class="px-4 py-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition text-sm">Voice Grid
                    (Vapi)</button>
            </div>
        </nav>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass p-6 rounded-2xl">
                <h3 class="text-slate-400 text-xs font-semibold uppercase">Total Leads</h3>
                <div class="text-3xl font-bold mt-2" id="statLeads">--</div>
            </div>
            <div class="glass p-6 rounded-2xl">
                <h3 class="text-slate-400 text-xs font-semibold uppercase">Pipeline Value</h3>
                <div class="text-3xl font-bold mt-2 text-green-400" id="statPipeline">--</div>
            </div>
            <div class="glass p-6 rounded-2xl">
                <h3 class="text-slate-400 text-xs font-semibold uppercase">Calls Made</h3>
                <div class="text-3xl font-bold mt-2 text-blue-400" id="statCalls">--</div>
            </div>
            <div class="glass p-6 rounded-2xl">
                <h3 class="text-slate-400 text-xs font-semibold uppercase">Appointments</h3>
                <div class="text-3xl font-bold mt-2 text-purple-400" id="statAppts">--</div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

            <!-- ORCHESTRATOR UPLINK -->
            <div
                class="glass p-6 rounded-2xl flex flex-col items-center justify-center text-center relative overflow-hidden">
                <div
                    class="w-20 h-20 bg-blue-500/20 rounded-full flex items-center justify-center mb-4 border border-blue-400/30">
                    <span class="text-4xl">üéôÔ∏è</span>
                </div>
                <h2 class="text-xl font-bold mb-1">Direct Uplink</h2>
                <p class="text-slate-400 text-xs mb-6">Talk to Antigravity (Orchestrator)</p>

                <button id="btnUplink" onclick="toggleUplink()"
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold w-full transition shadow-lg shadow-blue-500/20">
                    INITIATE LINK
                </button>
                <div id="statusUplink" class="mt-3 text-xs text-slate-500 font-mono">Status: Standby</div>
            </div>

            <!-- ACTIVE CAMPAIGN FEED -->
            <div class="glass p-6 rounded-2xl col-span-2 flex flex-col h-[400px]">
                <div class="flex justify-between items-center mb-4 border-b border-white/5 pb-2">
                    <h3 class="font-bold flex items-center gap-2">
                        <span>üì°</span> Live Campaign Feed
                    </h3>
                    <div class="flex gap-2">
                        <select id="campaignFilter" aria-label="Campaign Filter" onchange="fetchLeads()"
                            class="bg-slate-900 border border-slate-700 text-xs rounded px-2 py-1 outline-none text-slate-300">
                            <option value="ALL">All Campaigns</option>
                            <option value="roofing">Roofing (Foofer)</option>
                            <option value="hvac">HVAC</option>
                        </select>
                        <button onclick="fetchLeads()" class="text-xs text-blue-400 hover:text-blue-300">‚Üª
                            Refresh</button>
                    </div>
                </div>

                <!-- Table Header -->
                <div class="grid grid-cols-12 gap-2 text-xs text-slate-500 uppercase font-semibold mb-2 px-2">
                    <div class="col-span-4">Company / Name</div>
                    <div class="col-span-3">Status</div>
                    <div class="col-span-3">Details</div>
                    <div class="col-span-2 text-right">Action</div>
                </div>

                <!-- Scrollable Body -->
                <div class="flex-1 overflow-y-auto space-y-2 pr-2" id="leadsContainer">
                    <!-- Rows injected here -->
                    <div class="text-center text-slate-500 py-10">Connecting to Neural Net...</div>
                </div>
            </div>
        </div>

        <!-- ASSET INBOX (Feed the Brain) -->
        <div class="glass p-6 rounded-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold">üì• Asset Inbox (Feed The Brain)</h3>
                <span class="text-xs text-slate-500">Drag & Drop or Paste URL</span>
            </div>
            <div id="dropZone"
                class="border-2 border-dashed border-white/10 rounded-xl p-8 flex flex-col items-center justify-center text-center hover:border-blue-500/50 hover:bg-blue-500/5 transition cursor-pointer">
                <span class="text-2xl mb-2">üß†</span>
                <p class="text-sm text-slate-300 mb-2">"Here, learn this."</p>
                <input type="text" id="assetInput" placeholder="Paste URL..."
                    class="bg-slate-900 text-xs px-3 py-2 rounded border border-slate-700 w-64 text-center focus:border-blue-500 outline-none">
                <button onclick="saveAsset()"
                    class="mt-3 px-4 py-1 bg-green-600 hover:bg-green-500 rounded text-xs font-bold">SAVE TO
                    BRAIN</button>
                <div id="assetStatus" class="mt-2 text-[10px] text-slate-500"></div>
            </div>
        </div>

    </div>

    <!-- LOGIC -->
    <script>
        // --- 1. DATA FETCHING ---
        async function fetchStats() {
            // Simple counts
            const { count: total } = await supabase.from('leads').select('*', { count: 'exact', head: true });
            const { count: contacted } = await supabase.from('leads').select('*', { count: 'exact', head: true }).eq('status', 'contacted');
            const { count: calls } = await supabase.from('call_transcripts').select('*', { count: 'exact', head: true });
            // "Appointments" approximated
            const { count: appts } = await supabase.from('leads').select('*', { count: 'exact', head: true }).in('status', ['converted', 'appointment_set']);

            document.getElementById('statLeads').innerText = total || 0;
            // Dummy logic: $1000 per contacted lead for pipeline
            document.getElementById('statPipeline').innerText = "$" + ((contacted || 0) * 1000).toLocaleString();
            document.getElementById('statCalls').innerText = calls || 0;
            document.getElementById('statAppts').innerText = appts || 0;
        }

        async function fetchLeads() {
            const filter = document.getElementById('campaignFilter').value;
            let query = supabase.from('leads').select('*').order('created_at', { ascending: false }).limit(50);

            // Note: 'industry' is inside 'agent_research' JSONB usually, so perfect filtering might require raw SQL or standardized columns.
            // For now, we fetch recent 50 and filter client side if needed, or rely on implicit order.

            const { data, error } = await query;
            if (error) { console.error(error); return; }

            const container = document.getElementById('leadsContainer');
            container.innerHTML = '';

            data.forEach(lead => {
                // Parse JSONB
                const meta = typeof lead.agent_research === 'string' ? JSON.parse(lead.agent_research) : lead.agent_research || {};
                const industry = meta.industry || 'General';
                const phone = meta.phone || lead.phone || 'Unknown';

                // Color Code
                let badgeClass = "bg-slate-700 text-slate-300";
                if (lead.status === 'processing_email') badgeClass = "bg-orange-500/20 text-orange-400";
                if (lead.status === 'contacted') badgeClass = "bg-blue-500/20 text-blue-400";
                if (lead.status === 'system_crash') badgeClass = "bg-red-500/20 text-red-400 animate-pulse";
                if (lead.status === 'warming_up') badgeClass = "bg-yellow-500/20 text-yellow-400";

                const div = document.createElement('div');
                div.className = "grid grid-cols-12 gap-2 bg-white/5 p-3 rounded-lg items-center hover:bg-white/10 transition";
                div.innerHTML = `
                    <div class="col-span-4">
                        <div class="font-bold text-sm text-white truncate">${lead.company_name || 'Prospect'}</div>
                        <div class="text-[10px] text-slate-400">${industry}</div>
                    </div>
                    <div class="col-span-3">
                        <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${badgeClass}">${lead.status}</span>
                    </div>
                    <div class="col-span-3 text-[10px] font-mono text-slate-500">
                        ${phone}<br>${new Date(lead.created_at).toLocaleDateString()}
                    </div>
                    <div class="col-span-2 text-right">
                         <button onclick="viewDossier('${lead.id}')" class="text-blue-400 hover:text-white text-xs underline">VIEW</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function viewDossier(id) {
            alert("Open Dossier ID: " + id + "\\n(Feature coming in Sprint 2)");
        }

        // --- 2. VAPI UPLINK ---
        let isConnected = false;

        vapi.on('call-start', () => {
            console.log('Call started');
            document.getElementById('statusUplink').innerText = "Status: üü¢ ONLINE (Secure Channel)";
            document.getElementById('statusUplink').className = "mt-3 text-xs text-green-400 font-bold font-mono animate-pulse";
            document.getElementById('btnUplink').innerText = "DISCONNECT";
            document.getElementById('btnUplink').className = "px-6 py-3 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold w-full transition shadow-lg shadow-red-500/20";
        });

        vapi.on('call-end', () => {
            console.log('Call ended');
            resetUplinkUI();
        });

        function resetUplinkUI() {
            isConnected = false;
            document.getElementById('statusUplink').innerText = "Status: Standby";
            document.getElementById('statusUplink').className = "mt-3 text-xs text-slate-500 font-mono";
            document.getElementById('btnUplink').innerText = "INITIATE LINK";
            document.getElementById('btnUplink').className = "px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold w-full transition shadow-lg shadow-blue-500/20";
        }

        function toggleUplink() {
            if (isConnected) {
                vapi.stop();
                isConnected = false;
            } else {
                document.getElementById('statusUplink').innerText = "Status: Handshaking...";
                vapi.start(ORCHESTRATOR_ID);
                isConnected = true;
            }
        }

        // --- 3. ASSET INBOX ---
        async function saveAsset() {
            const url = document.getElementById('assetInput').value;
            const status = document.getElementById('assetStatus');

            if (!url) return;
            status.innerText = "Ingesting...";
            status.className = "mt-2 text-[10px] text-blue-400";

            // Push to Supabase 'asset_inbox' or just 'system_logs' for now if table missing
            // We'll trust 'leads' table for loose storage if needed, but better to log it.
            const { error } = await supabase.from('system_logs').insert({
                level: 'INFO',
                event_type: 'ASSET_UPLOAD',
                message: 'Asset Uploaded from Dashboard: ' + url,
                metadata: { url: url, source: 'dashboard' }
            });

            if (!error) {
                status.innerText = "‚úÖ Saved to Brain";
                status.className = "mt-2 text-[10px] text-green-400";
                document.getElementById('assetInput').value = "";
                setTimeout(() => status.innerText = "", 3000);
            } else {
                status.innerText = "‚ùå Error";
                status.className = "mt-2 text-[10px] text-red-500";
            }
        }

        // --- 4. INIT ---
        window.addEventListener('load', () => {
            fetchStats();
            fetchLeads();
            setInterval(fetchStats, 10000); // 10s refresh
            setInterval(fetchLeads, 10000);
        });

    </script>
</body>

</html>