l# Master Recovery Protocol (Empire Unified)

Last Updated: 2025-12-31

## 1. Critical Actions (Immediate Recovery)

### A. Database Restoration (If Tables Missing)

If call logs show "Error executing tool" or "Table not found":

1. Log in to **Supabase Dashboard**.
2. Open **SQL Editor**.
3. Click **New Query**.
4. Paste the contents of `setup_office_tables.sql` (found in repository root).

    ```sql
    create table if not exists office_inventory (id bigint generated by default as identity primary key, item text not null unique, quantity integer default 0);
    create table if not exists office_tasks (id bigint generated by default as identity primary key, description text not null, status text default 'pending', created_at timestamp with time zone default timezone('utc'::text, now()));
    insert into office_inventory (item, quantity) values ('paper', 100), ('coffee', 2) on conflict (item) do nothing;
    ```

5. Click **Run**.

### B. Autonomy Restoration (If Vapi/Modal Fails)

If the agent stops checking inventory or responding to requests:

1. **Re-Deploy Backend Logic**:

    ```bash
    python -m modal deploy modules/orchestrator/deploy.py
    ```

    *This restores the `office_voice_tool` endpoint which Vapi talks to.*

2. **Re-Configure Vapi Agent**:

    ```bash
    python setup_vapi_direct.py
    ```

    *This re-injects the Server URL and System Prompt (including the Security Protocol).*

### C. Revenue System Restoration (Stripe/Vercel)

If the checkout flow fails or 500 errors occur:

1. **Check Vercel Deployment**:
    - Go to **Vercel Dashboard** -> **Deployments**.
    - If status is "Error", check logs for `ImportError` or `AuthenticationError`.
2. **Verify Stripe Key**:
    - Ensure `STRIPE_SECRET_KEY` in Vercel Settings starts with `sk_live_`.
    - Use `python verify_key_local.py` (locally) to test if the key itself is valid.
3. **Redeploy API**:

    ```bash
    cd c:\Users\nearm\.gemini\antigravity\scratch\empire-unified
    vercel deploy --prod
    ```

4. **Health Check**:
    - Visit `https://empire-sovereign-cloud.vercel.app/api/health` to confirm dependencies (Stripe, Resend, PG8000) are loaded.

## 2. Security Protocol (Office Manager)

The current active agent is "Office Manager Orchestrator".

- **Rule**: It MUST repeat tasks back to you.
- **Key**: It MUST demand code `11752990` to execute database writes.
- **Failure**: If it executes without code, re-run `python setup_vapi_direct.py` immediately to reset the system prompt.

## 3. Git Repository

All source code is saved in `c:/Users/nearm/.gemini/antigravity/scratch/empire-unified`.

- **Push Updates**: `git add . && git commit -m "Recovery Point" && git push`

## 4. Level 5 Authority (Future Upgrade)

To grant full database creation rights to the system:

1. Get Connection String from Supabase > Settings > Database > Connection Parameters > URI.
2. Add to `.env`: `DATABASE_URL=postgresql://postgres...` (See `AUTHORITY_UPGRADE.md` for full steps).

## 5. Contact

For hard resets, email: `owner@aiserviceco.com`
